# Comprehensive Diagnostic Check - University Bus Tracking System
# Checks for TypeScript errors, syntax issues, and configuration problems

Write-Host "üîç Comprehensive Diagnostic Check - University Bus Tracking System" -ForegroundColor Cyan
Write-Host "=================================================================" -ForegroundColor Cyan

# Test 1: Backend TypeScript Compilation
Write-Host "`nüì¶ Test 1: Backend TypeScript Compilation..." -ForegroundColor Yellow
try {
    $backendResult = & cd backend; npx tsc --noEmit 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Backend TypeScript compilation successful" -ForegroundColor Green
    } else {
        Write-Host "‚ùå Backend TypeScript compilation failed:" -ForegroundColor Red
        Write-Host $backendResult -ForegroundColor Red
    }
} catch {
    Write-Host "‚ùå Error running backend TypeScript check: $_" -ForegroundColor Red
}

# Test 2: Frontend TypeScript Compilation
Write-Host "`nüì¶ Test 2: Frontend TypeScript Compilation..." -ForegroundColor Yellow
try {
    $frontendResult = & cd frontend; npx tsc --noEmit 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Frontend TypeScript compilation successful" -ForegroundColor Green
    } else {
        Write-Host "‚ùå Frontend TypeScript compilation failed:" -ForegroundColor Red
        Write-Host $frontendResult -ForegroundColor Red
    }
} catch {
    Write-Host "‚ùå Error running frontend TypeScript check: $_" -ForegroundColor Red
}

# Test 3: Check for syntax errors in key files
Write-Host "`nüîç Test 3: Syntax Check for Key Files..." -ForegroundColor Yellow

# Check StudentMap.tsx
if (Test-Path "frontend/src/components/StudentMap.tsx") {
    try {
        $content = Get-Content "frontend/src/components/StudentMap.tsx" -Raw
        if ($content -match '^\s*</div>\s*$') {
            Write-Host "‚ö†Ô∏è  Potential extra closing div tag in StudentMap.tsx" -ForegroundColor Yellow
        } else {
            Write-Host "‚úÖ StudentMap.tsx syntax looks good" -ForegroundColor Green
        }
    } catch {
        Write-Host "‚ùå Error reading StudentMap.tsx: $_" -ForegroundColor Red
    }
}

# Check buses.ts
if (Test-Path "backend/src/routes/buses.ts") {
    try {
        $content = Get-Content "backend/src/routes/buses.ts" -Raw
        if ($content -match 'return res\.json') {
            Write-Host "‚úÖ buses.ts return statements look good" -ForegroundColor Green
        } else {
            Write-Host "‚ö†Ô∏è  Potential missing return statements in buses.ts" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "‚ùå Error reading buses.ts: $_" -ForegroundColor Red
    }
}

# Test 4: Check for missing dependencies
Write-Host "`nüì¶ Test 4: Dependency Check..." -ForegroundColor Yellow

# Check backend dependencies
$backendDeps = @("express", "socket.io", "pg", "@supabase/supabase-js")
foreach ($dep in $backendDeps) {
    $packageJson = Get-Content "backend/package.json" -Raw
    if ($packageJson -match $dep) {
        Write-Host "‚úÖ $dep found in backend" -ForegroundColor Green
    } else {
        Write-Host "‚ùå $dep missing from backend" -ForegroundColor Red
    }
}

# Check frontend dependencies
$frontendDeps = @("react", "maplibre-gl", "socket.io-client")
foreach ($dep in $frontendDeps) {
    $packageJson = Get-Content "frontend/package.json" -Raw
    if ($packageJson -match $dep) {
        Write-Host "‚úÖ $dep found in frontend" -ForegroundColor Green
    } else {
        Write-Host "‚ùå $dep missing from frontend" -ForegroundColor Red
    }
}

# Test 5: Check for configuration issues
Write-Host "`n‚öôÔ∏è Test 5: Configuration Check..." -ForegroundColor Yellow

# Check TypeScript configs
if (Test-Path "backend/tsconfig.json") {
    Write-Host "‚úÖ Backend tsconfig.json exists" -ForegroundColor Green
} else {
    Write-Host "‚ùå Backend tsconfig.json missing" -ForegroundColor Red
}

if (Test-Path "frontend/tsconfig.json") {
    Write-Host "‚úÖ Frontend tsconfig.json exists" -ForegroundColor Green
} else {
    Write-Host "‚ùå Frontend tsconfig.json missing" -ForegroundColor Red
}

# Check environment files
if (Test-Path "backend/.env") {
    Write-Host "‚úÖ Backend .env exists" -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è  Backend .env missing (may be expected)" -ForegroundColor Yellow
}

if (Test-Path "frontend/.env") {
    Write-Host "‚úÖ Frontend .env exists" -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è  Frontend .env missing (may be expected)" -ForegroundColor Yellow
}

# Test 6: Check for import/export issues
Write-Host "`nüì§ Test 6: Import/Export Check..." -ForegroundColor Yellow

# Check if all components are properly exported
$components = @("StudentMap", "DriverInterface")
foreach ($comp in $components) {
    $filePath = "frontend/src/components/$comp.tsx"
    if (Test-Path $filePath) {
        $content = Get-Content $filePath -Raw
        if ($content -match "export default $comp") {
            Write-Host "‚úÖ $comp properly exported" -ForegroundColor Green
        } else {
            Write-Host "‚ùå $comp export issue" -ForegroundColor Red
        }
    } else {
        Write-Host "‚ùå $comp.tsx missing" -ForegroundColor Red
    }
}

# Test 7: Check for CSS import issues
Write-Host "`nüé® Test 7: CSS Import Check..." -ForegroundColor Yellow

$cssContent = Get-Content "frontend/src/index.css" -Raw
if ($cssContent -match "maplibre-gl/dist/maplibre-gl.css") {
    Write-Host "‚úÖ MapLibre CSS import found" -ForegroundColor Green
} else {
    Write-Host "‚ùå MapLibre CSS import missing" -ForegroundColor Red
}

if (Test-Path "frontend/src/components/StudentMap.css") {
    Write-Host "‚úÖ StudentMap.css exists" -ForegroundColor Green
} else {
    Write-Host "‚ùå StudentMap.css missing" -ForegroundColor Red
}

# Test 8: Check for WebSocket configuration
Write-Host "`nüîå Test 8: WebSocket Configuration Check..." -ForegroundColor Yellow

if (Test-Path "backend/src/sockets/websocket.ts") {
    Write-Host "‚úÖ WebSocket server file exists" -ForegroundColor Green
} else {
    Write-Host "‚ùå WebSocket server file missing" -ForegroundColor Red
}

if (Test-Path "frontend/src/services/websocket.ts") {
    Write-Host "‚úÖ WebSocket client service exists" -ForegroundColor Green
} else {
    Write-Host "‚ùå WebSocket client service missing" -ForegroundColor Red
}

# Test 9: Check for API service configuration
Write-Host "`nüåê Test 9: API Service Check..." -ForegroundColor Yellow

if (Test-Path "frontend/src/services/api.ts") {
    $apiContent = Get-Content "frontend/src/services/api.ts" -Raw
    if ($apiContent -match "getAllBuses" -and $apiContent -match "getBusInfo") {
        Write-Host "‚úÖ API service has bus endpoints" -ForegroundColor Green
    } else {
        Write-Host "‚ùå API service missing bus endpoints" -ForegroundColor Red
    }
} else {
    Write-Host "‚ùå API service file missing" -ForegroundColor Red
}

# Test 10: Check for bus service
Write-Host "`nüöå Test 10: Bus Service Check..." -ForegroundColor Yellow

if (Test-Path "frontend/src/services/busService.ts") {
    Write-Host "‚úÖ Bus service exists" -ForegroundColor Green
} else {
    Write-Host "‚ùå Bus service missing" -ForegroundColor Red
}

Write-Host "`nüéâ Diagnostic Check Complete!" -ForegroundColor Green
Write-Host "=================================" -ForegroundColor Green

Write-Host "`nüìã Summary:" -ForegroundColor Cyan
Write-Host "If all tests passed, your project should be ready to run." -ForegroundColor White
Write-Host "If any tests failed, please address the issues before proceeding." -ForegroundColor White

Write-Host "`nüöÄ Next Steps:" -ForegroundColor Yellow
Write-Host "1. Start backend: cd backend; npm run dev" -ForegroundColor White
Write-Host "2. Start frontend: cd frontend; npm run dev" -ForegroundColor White
Write-Host "3. Test the application in your browser" -ForegroundColor White
