const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/MapContainer-BeAxOB0k.js","assets/js/index-B1j8FRVx.js","assets/js/vendor-react-CyT1AhbS.js","assets/js/vendor-ui-D_U17TOn.js","assets/js/vendor-router-BXLLWNa2.js","assets/js/vendor-state-B-5mdhwp.js","assets/js/vendor-websocket-TjCxX7sJ.js","assets/js/vendor-maps-C78ko_py.js","assets/js/vendor-animations-jk_Di6sJ.js","assets/css/index-IKnwowZs.css","assets/js/BusMarker-CrDKL-TA.js"])))=>i.map(i=>d[i]);
var ye=Object.defineProperty;var Le=(l,e,t)=>e in l?ye(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var p=(l,e,t)=>Le(l,typeof e!="symbol"?e+"":e,t);import{_ as ae}from"./vendor-ui-D_U17TOn.js";import{e as H,s as B,a as oe,d as we,j as c,G as M,u as ke,b as Re,c as ze,f as Me}from"./index-B1j8FRVx.js";import{r as f,a as ce}from"./vendor-react-CyT1AhbS.js";import{l as je}from"./vendor-websocket-TjCxX7sJ.js";import{c as De}from"./vendor-state-B-5mdhwp.js";import{A as U,m as W}from"./vendor-animations-jk_Di6sJ.js";import"./vendor-router-BXLLWNa2.js";import"./vendor-maps-C78ko_py.js";class Be{constructor(){p(this,"errorLog",[]);p(this,"maxLogSize",100)}logError(e,t,n="medium"){let s;e instanceof Error?s=e.message:typeof e=="string"?s=e:e instanceof Event?s=`Event error: ${e.type}`:s="Unknown error";let i={};if(typeof navigator<"u"&&"connection"in navigator){const a=navigator.connection;a&&(i={effectiveType:a.effectiveType,downlink:a.downlink,rtt:a.rtt,saveData:a.saveData})}const o={message:s,context:{service:t.service||"api",operation:t.operation||"unknown",timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href,networkInfo:i,...t},severity:n,retryable:this.isRetryableError(e),suggestions:this.getSuggestions(e,t)};return this.errorLog.push(o),this.errorLog.length>this.maxLogSize&&this.errorLog.shift(),this.logToConsole(o),o}isRetryableError(e){let t;return e instanceof Error?t=e.message:typeof e=="string"?t=e:e instanceof Event?t=e.type:t="Unknown error",[/network/i,/timeout/i,/connection/i,/cors/i,/fetch/i,/websocket/i,/sse/i,/socket\.io/i,/error/i,/failed/i,/disconnect/i].some(s=>s.test(t))}getSuggestions(e,t){let n;e instanceof Error?n=e.message:typeof e=="string"?n=e:e instanceof Event?n=e.type:n="Unknown error";const s=[];return n.includes("CORS")&&(s.push("Check CORS configuration on the server"),s.push("Verify the API endpoint is accessible")),n.includes("timeout")&&(s.push("Increase connection timeout settings"),s.push("Check network connectivity")),n.includes("websocket")&&(s.push("Verify WebSocket server is running"),s.push("Check WebSocket URL configuration")),n.includes("sse")&&(s.push("Verify SSE endpoint is implemented on server"),s.push("Check SSE URL configuration")),n.includes("supabase")&&(s.push("Verify Supabase configuration"),s.push("Check Supabase service status")),s.length===0&&(s.push("Check network connectivity"),s.push("Verify server is running"),s.push("Check browser console for more details")),s}logToConsole(e){const{message:t,context:n,severity:s,retryable:i,suggestions:o}=e,u={low:"color: #6b7280",medium:"color: #f59e0b",high:"color: #ef4444",critical:"color: #dc2626; font-weight: bold"}[s],m=i?"üîÑ Retryable":"‚ùå Not Retryable";console.group(`%c${s.toUpperCase()} ERROR - ${n.service.toUpperCase()}`,u),console.error(`Message: ${t}`),console.error(`Service: ${n.service}`),console.error(`Operation: ${n.operation}`),console.error(`Status: ${m}`),console.error(`Timestamp: ${n.timestamp}`),o.length>0&&(console.warn("Suggestions:"),o.forEach(g=>console.warn(`  ‚Ä¢ ${g}`))),console.groupEnd()}getErrorStats(){const e={},t={};return this.errorLog.forEach(n=>{e[n.context.service]=(e[n.context.service]||0)+1,t[n.severity]=(t[n.severity]||0)+1}),{total:this.errorLog.length,byService:e,bySeverity:t,recentErrors:this.errorLog.slice(-10)}}clearLog(){this.errorLog=[]}getErrors(){return[...this.errorLog]}hasCriticalErrors(){return this.errorLog.some(e=>e.severity==="critical")}getRetryableErrors(){return this.errorLog.filter(e=>e.retryable)}}const Ae=new Be,V=(l,e,t)=>Ae.logError(l,e,t);class Ve{constructor(){p(this,"connections",new Map);p(this,"connectionStatus",new Map);p(this,"connectionConfigs",new Map);p(this,"eventListeners",new Map);p(this,"healthCheckInterval",null);this.initializeDefaultConnections(),this.startHealthCheck()}initializeDefaultConnections(){}ensureConnectionsInitialized(){if(this.connectionConfigs.size>0)return;let e=H.api.websocketUrl;if(!e&&typeof window<"u"){const n=window.location.protocol==="https:"?"wss:":"ws:",s=window.location.hostname;e=`${n}//${s}:3000`}const t=e||"ws://localhost:3000";console.log("üîå Initializing WebSocket connections with URL:",t),this.addConnection({name:"location-updates",url:t,priority:"high",autoReconnect:!0,maxReconnectAttempts:15,options:{transports:["websocket","polling"],timeout:15e3,reconnection:!0,reconnectionAttempts:15,reconnectionDelay:1e3,reconnectionDelayMax:5e3,query:{clientType:"student",connectionType:"location-updates",version:"1.0.0"}}}),this.addConnection({name:"general-updates",url:t,priority:"medium",autoReconnect:!0,maxReconnectAttempts:10,options:{transports:["websocket","polling"],timeout:2e4,reconnection:!0,reconnectionAttempts:10,reconnectionDelay:2e3,reconnectionDelayMax:1e4,query:{clientType:"student",connectionType:"general-updates",version:"1.0.0"}}}),this.addConnection({name:"analytics",url:t,priority:"low",autoReconnect:!1,maxReconnectAttempts:3,options:{transports:["polling"],timeout:3e4,reconnection:!1,query:{clientType:"student",connectionType:"analytics",version:"1.0.0"}}})}addConnection(e){this.connectionConfigs.set(e.name,e),this.connectionStatus.set(e.name,{name:e.name,isConnected:!1,isConnecting:!1,lastHeartbeat:0,reconnectAttempts:0}),this.eventListeners.set(e.name,new Map)}async connect(e){this.ensureConnectionsInitialized();const t=this.connectionConfigs.get(e);if(!t)throw new Error(`Connection configuration not found: ${e}`);const n=this.connections.get(e);if(n!=null&&n.connected){console.log(`üîå Connection ${e} already connected`);return}const s=this.connectionStatus.get(e);if(s.isConnecting){console.log(`üîå Connection ${e} already connecting`);return}try{s.isConnecting=!0,console.log(`üîå Connecting to ${e}...`);const i=setTimeout(()=>{s.isConnecting&&(console.warn(`‚ö†Ô∏è Connection timeout for ${e}`),s.isConnecting=!1,s.error="Connection timeout",V(new Error(`Connection timeout for ${e}`),{service:"websocket",operation:`connect-${e}`},"medium"),t.autoReconnect&&s.reconnectAttempts<t.maxReconnectAttempts&&this.scheduleReconnect(e))},15e3),o=je(t.url,{...t.options,timeout:15e3,forceNew:!0,transports:["websocket","polling"],upgrade:!0,rememberUpgrade:!0,autoConnect:!1,reconnection:!0,reconnectionAttempts:10,reconnectionDelay:1e3,reconnectionDelayMax:5e3,maxReconnectionAttempts:10});o.on("connect",()=>{console.log(`‚úÖ Connected to ${e}`),clearTimeout(i),s.isConnected=!0,s.isConnecting=!1,s.reconnectAttempts=0,s.lastHeartbeat=Date.now(),s.error=void 0}),o.on("disconnect",a=>{console.log(`‚ùå Disconnected from ${e}: ${a}`),s.isConnected=!1,s.isConnecting=!1,t.autoReconnect&&s.reconnectAttempts<t.maxReconnectAttempts&&this.scheduleReconnect(e)}),o.on("connect_error",a=>{console.error(`‚ùå Connection error for ${e}:`,a),clearTimeout(i),s.error=a.message,s.isConnecting=!1,V(a,{service:"websocket",operation:`connect-${e}`},"medium"),t.autoReconnect&&s.reconnectAttempts<t.maxReconnectAttempts&&this.scheduleReconnect(e)}),o.on("error",a=>{console.error(`‚ùå Socket error for ${e}:`,a),s.error=a.message}),o.on("pong",()=>{s.lastHeartbeat=Date.now()}),this.connections.set(e,o),o.connect()}catch(i){throw console.error(`‚ùå Failed to create connection for ${e}:`,i),s.isConnecting=!1,s.error=i instanceof Error?i.message:"Unknown error",i}}scheduleReconnect(e){const t=this.connectionConfigs.get(e),n=this.connectionStatus.get(e);if(!t||!n)return;n.reconnectAttempts++;const s=Math.min(1e3*Math.pow(2,n.reconnectAttempts-1),3e4);console.log(`üîÑ Scheduling reconnect for ${e} in ${s}ms (attempt ${n.reconnectAttempts}/${t.maxReconnectAttempts})`),setTimeout(()=>{n.reconnectAttempts<t.maxReconnectAttempts&&this.connect(e)},s)}disconnect(e){const t=this.connections.get(e);t&&(t.disconnect(),this.connections.delete(e));const n=this.connectionStatus.get(e);n&&(n.isConnected=!1,n.isConnecting=!1)}disconnectAll(){for(const[e]of this.connections)this.disconnect(e)}emit(e,t,n){const s=this.connections.get(e);s!=null&&s.connected?s.emit(t,n):console.warn(`‚ö†Ô∏è Cannot emit to ${e}: not connected`)}on(e,t,n){const s=this.connections.get(e);if(s){s.on(t,n);const i=this.eventListeners.get(e);i&&(i.has(t)||i.set(t,[]),i.get(t).push(n))}}off(e,t,n){const s=this.connections.get(e);s&&(n?s.off(t,n):s.off(t))}getConnectionStatus(e){return this.connectionStatus.get(e)}getAllConnectionStatus(){return Array.from(this.connectionStatus.values())}isConnected(e){const t=this.connectionStatus.get(e);return(t==null?void 0:t.isConnected)||!1}startHealthCheck(){this.healthCheckInterval=setInterval(()=>{const e=Date.now();for(const[t,n]of this.connectionStatus)n.isConnected&&n.lastHeartbeat>0&&e-n.lastHeartbeat>6e4&&(console.warn(`‚ö†Ô∏è Connection ${t} appears dead, reconnecting...`),this.disconnect(t),this.connect(t))},3e4)}destroy(){this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.disconnectAll(),this.connections.clear(),this.connectionStatus.clear(),this.connectionConfigs.clear(),this.eventListeners.clear()}}const S=new Ve;class Pe{constructor(){p(this,"subscriptions",new Map);p(this,"channels",new Map);p(this,"isEnabled",!0);this.initializeRealtime()}async initializeRealtime(){try{await this.enableRealtimeForTables(["live_locations","bus_locations_live","buses","routes","driver_bus_assignments"]),console.log("‚úÖ Supabase Realtime initialized")}catch(e){console.error("‚ùå Failed to initialize Supabase Realtime:",e)}}async enableRealtimeForTables(e){console.log("üîß Enabling realtime for tables:",e)}subscribeToBusLocations(e,t){const n=`bus-locations-${Date.now()}`,s={id:n,table:"live_locations",event:"*",filter:t,callback:e};this.subscriptions.set(n,s);const i=B.channel(n).on("postgres_changes",{event:"*",schema:"public",table:"live_locations",filter:t},o=>{console.log("üìç Bus location update via Supabase Realtime:",o),e(o)}).subscribe(o=>{console.log(`üîå Supabase Realtime subscription status for ${n}:`,o),o==="SUBSCRIBED"&&this.channels.set(n,i)});return n}subscribeToBusUpdates(e,t){const n=`bus-updates-${Date.now()}`,s={id:n,table:"buses",event:"*",filter:t,callback:e};this.subscriptions.set(n,s);const i=B.channel(n).on("postgres_changes",{event:"*",schema:"public",table:"buses",filter:t},o=>{console.log("üöå Bus update via Supabase Realtime:",o),e(o)}).subscribe(o=>{console.log(`üîå Supabase Realtime subscription status for ${n}:`,o),o==="SUBSCRIBED"&&this.channels.set(n,i)});return n}subscribeToRouteUpdates(e,t){const n=`route-updates-${Date.now()}`,s={id:n,table:"routes",event:"*",filter:t,callback:e};this.subscriptions.set(n,s);const i=B.channel(n).on("postgres_changes",{event:"*",schema:"public",table:"routes",filter:t},o=>{console.log("üõ£Ô∏è Route update via Supabase Realtime:",o),e(o)}).subscribe(o=>{console.log(`üîå Supabase Realtime subscription status for ${n}:`,o),o==="SUBSCRIBED"&&this.channels.set(n,i)});return n}subscribeToDriverAssignments(e,t){const n=`driver-assignments-${Date.now()}`,s={id:n,table:"driver_bus_assignments",event:"*",filter:t,callback:e};this.subscriptions.set(n,s);const i=B.channel(n).on("postgres_changes",{event:"*",schema:"public",table:"driver_bus_assignments",filter:t},o=>{console.log("üë®‚Äçüíº Driver assignment update via Supabase Realtime:",o),e(o)}).subscribe(o=>{console.log(`üîå Supabase Realtime subscription status for ${n}:`,o),o==="SUBSCRIBED"&&this.channels.set(n,i)});return n}subscribe(e,t,n,s){const i=`${e}-${t}-${Date.now()}`,o={id:i,table:e,event:t,filter:s,callback:n};this.subscriptions.set(i,o);const a=B.channel(i).on("postgres_changes",{event:t,schema:"public",table:e,filter:s},u=>{console.log(`üìä ${e} ${t} via Supabase Realtime:`,u),n(u)}).subscribe(u=>{console.log(`üîå Supabase Realtime subscription status for ${i}:`,u),u==="SUBSCRIBED"&&this.channels.set(i,a)});return i}unsubscribe(e){const t=this.subscriptions.get(e),n=this.channels.get(e);return t&&n?(B.removeChannel(n),this.subscriptions.delete(e),this.channels.delete(e),console.log(`üîå Unsubscribed from ${e}`),!0):!1}unsubscribeAll(){for(const[e]of this.subscriptions)this.unsubscribe(e)}getSubscriptionStatus(e){return this.subscriptions.has(e)}getActiveSubscriptions(){return Array.from(this.subscriptions.values())}setEnabled(e){this.isEnabled=e,e||this.unsubscribeAll()}isRealtimeEnabled(){return this.isEnabled}async healthCheck(){try{const e=this.getActiveSubscriptions();return{healthy:this.isEnabled&&e.length>0,details:{enabled:this.isEnabled,activeSubscriptions:e.length,subscriptions:e.map(n=>({id:n.id,table:n.table,event:n.event}))}}}catch(e){return{healthy:!1,details:{error:e instanceof Error?e.message:"Unknown error"}}}}destroy(){this.unsubscribeAll(),this.subscriptions.clear(),this.channels.clear()}}const z=new Pe,$=()=>{const l=navigator.userAgent,e=/Firefox/.test(l),t=/Chrome/.test(l)&&!/Edge/.test(l),n=/Safari/.test(l)&&!/Chrome/.test(l),s=/Edge/.test(l);let i="";if(e){const o=l.match(/Firefox\/(\d+)/);i=o?o[1]:""}else if(t){const o=l.match(/Chrome\/(\d+)/);i=o?o[1]:""}else if(n){const o=l.match(/Version\/(\d+)/);i=o?o[1]:""}else if(s){const o=l.match(/Edge\/(\d+)/);i=o?o[1]:""}return{isFirefox:e,isChrome:t,isSafari:n,isEdge:s,version:i,userAgent:l}},Ie=()=>$().isFirefox?(console.log("ü¶ä Firefox detected - using Firefox-specific EventSource configuration"),{withCredentials:!1}):{withCredentials:!1},Oe=()=>{if(!$().isFirefox)return!1;const e=navigator.userAgent.includes("Firefox")&&(navigator.userAgent.includes("Firefox/78")||navigator.userAgent.includes("Firefox/79")||navigator.userAgent.includes("Firefox/8")||navigator.userAgent.includes("Firefox/9")||navigator.userAgent.includes("Firefox/10")||navigator.userAgent.includes("Firefox/11")||navigator.userAgent.includes("Firefox/12"));return e&&console.log("ü¶ä Firefox Enhanced Tracking Protection may be active"),e},$e=()=>{const l=$(),e=[];return l.isFirefox&&e.push("ü¶ä Firefox detected - if you experience CORS issues:","1. Disable Enhanced Tracking Protection for localhost","2. Go to about:config and set security.fileuri.strict_origin_policy to false","3. Try using Private Browsing mode","4. Disable browser extensions temporarily"),e},Te=()=>{const l=$();l.isFirefox&&console.log("ü¶ä Firefox Debug Information:",{version:l.version,userAgent:l.userAgent,hasTrackingProtection:Oe(),recommendations:$e()})};class _e{constructor(e){p(this,"eventSource",null);p(this,"subscriptions",new Map);p(this,"isConnected",!1);p(this,"reconnectAttempts",0);p(this,"maxReconnectAttempts",5);p(this,"reconnectDelay",1e3);p(this,"reconnectTimeout",null);p(this,"config");this.config={url:`${H.api.url}/sse`,retryInterval:5e3,maxRetries:5,timeout:3e4,...e}}async connect(){if(this.eventSource){console.log("üîå SSE already connected");return}try{console.log("üîå Connecting to SSE endpoint...");const e=new URL(this.config.url,window.location.origin);console.log("üîå Connecting to SSE endpoint at:",e.toString()),Te();const t=Ie();console.log("üîå EventSource options:",t);try{this.eventSource=new EventSource(e.toString(),t)}catch(n){console.error("‚ùå Failed to create EventSource:",n);try{console.log("üîÑ Trying Firefox fallback EventSource without options..."),this.eventSource=new EventSource(e.toString())}catch(s){throw console.error("‚ùå Firefox fallback EventSource also failed:",s),s}}this.setupEventListeners()}catch(e){console.error("‚ùå Failed to connect to SSE:",e),this.scheduleReconnect()}}setupEventListeners(){this.eventSource&&(this.eventSource.onopen=()=>{console.log("‚úÖ SSE connection opened"),this.isConnected=!0,this.reconnectAttempts=0},this.eventSource.onerror=e=>{var t;console.error("‚ùå SSE connection error:",e),this.isConnected=!1,V(e instanceof Error?e:new Error("SSE connection error"),{service:"sse",operation:"connect"},"medium"),((t=this.eventSource)==null?void 0:t.readyState)===EventSource.CLOSED&&this.scheduleReconnect()},this.setupSpecificEventListeners())}setupSpecificEventListeners(){this.eventSource&&(this.eventSource.addEventListener("bus-location-update",e=>{try{const t=JSON.parse(e.data);this.handleEvent("bus-location-update",t)}catch(t){console.error("‚ùå Error parsing bus location update:",t)}}),this.eventSource.addEventListener("bus-status-update",e=>{try{const t=JSON.parse(e.data);this.handleEvent("bus-status-update",t)}catch(t){console.error("‚ùå Error parsing bus status update:",t)}}),this.eventSource.addEventListener("route-update",e=>{try{const t=JSON.parse(e.data);this.handleEvent("route-update",t)}catch(t){console.error("‚ùå Error parsing route update:",t)}}),this.eventSource.addEventListener("system-notification",e=>{try{const t=JSON.parse(e.data);this.handleEvent("system-notification",t)}catch(t){console.error("‚ùå Error parsing system notification:",t)}}),this.eventSource.addEventListener("message",e=>{try{const t=JSON.parse(e.data);this.handleEvent("message",t)}catch(t){console.error("‚ùå Error parsing generic message:",t)}}))}handleEvent(e,t){const n={type:e,data:t,timestamp:Date.now()};console.log(`üì° SSE Event received: ${e}`,n);for(const s of this.subscriptions.values())if(s.eventType===e&&s.isActive)try{s.callback(n)}catch(i){console.error(`‚ùå Error in SSE subscription callback for ${e}:`,i)}}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("‚ùå Max SSE reconnection attempts reached"),V(new Error("Max SSE reconnection attempts reached"),{service:"sse",operation:"reconnect"},"high");return}this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`üîÑ Scheduling SSE reconnect in ${e}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),this.reconnectTimeout=setTimeout(()=>{this.isConnected||(this.disconnect(),this.connect())},e)}subscribe(e,t){const n=`sse-${e}-${Date.now()}`,s={id:n,eventType:e,callback:t,isActive:!0};return this.subscriptions.set(n,s),console.log(`üîå SSE subscription created for ${e}: ${n}`),n}unsubscribe(e){const t=this.subscriptions.get(e);return t?(t.isActive=!1,this.subscriptions.delete(e),console.log(`üîå SSE subscription removed: ${e}`),!0):!1}unsubscribeAll(){for(const[e]of this.subscriptions)this.unsubscribe(e)}disconnect(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.isConnected=!1,console.log("üîå SSE disconnected")}isSSEConnected(){var e;return this.isConnected&&((e=this.eventSource)==null?void 0:e.readyState)===EventSource.OPEN}getConnectionStatus(){var e;return{isConnected:this.isConnected,readyState:((e=this.eventSource)==null?void 0:e.readyState)||EventSource.CLOSED,reconnectAttempts:this.reconnectAttempts,activeSubscriptions:Array.from(this.subscriptions.values()).filter(t=>t.isActive).length}}async healthCheck(){const e=this.getConnectionStatus();return{healthy:e.isConnected&&e.readyState===EventSource.OPEN,details:{...e,config:this.config}}}destroy(){this.disconnect(),this.unsubscribeAll(),this.subscriptions.clear()}}const y=new _e;class Fe{constructor(e){p(this,"config");p(this,"eventListeners",new Map);p(this,"isInitialized",!1);p(this,"healthCheckInterval",null);this.config={enableWebSocket:!0,enableSupabaseRealtime:!0,enableSSE:!0,priority:"hybrid",fallbackStrategy:"websocket",...e}}async initialize(){if(this.isInitialized){console.log("üîÑ RealtimeManager already initialized");return}console.log("üöÄ Initializing RealtimeManager...");try{const e=[];this.config.enableSupabaseRealtime&&e.push(this.initializeSupabaseRealtime().catch(s=>(console.warn("‚ö†Ô∏è Supabase Realtime initialization failed:",s),null))),this.config.enableWebSocket&&e.push(this.initializeWebSocket().catch(s=>(console.warn("‚ö†Ô∏è WebSocket initialization failed:",s),null))),this.config.enableSSE&&e.push(this.initializeSSE().catch(s=>(console.warn("‚ö†Ô∏è SSE initialization failed:",s),null)));const n=(await Promise.allSettled(e)).filter(s=>s.status==="fulfilled"&&s.value!==null).length;n===0?console.warn("‚ö†Ô∏è No real-time services initialized successfully"):console.log(`‚úÖ RealtimeManager initialized with ${n} service(s)`),this.isInitialized=!0,this.startHealthCheck()}catch(e){throw console.error("‚ùå Failed to initialize RealtimeManager:",e),this.isInitialized=!1,e}}async initializeWebSocket(){console.log("üîå Initializing WebSocket connection pool...");try{const e=H.api.url;console.log("üîå Checking backend availability at:",e);const t=await fetch(e+"/health");if(!t.ok)throw new Error(`Backend health check failed: ${t.statusText}`);const n=await t.json();console.log("‚úÖ Backend health check successful:",n),await S.connect("location-updates"),await S.connect("general-updates"),this.setupWebSocketListeners(),console.log("‚úÖ WebSocket connections established successfully")}catch(e){console.warn("‚ö†Ô∏è WebSocket initialization failed, falling back to Supabase Realtime:",e),V(e instanceof Error?e:new Error("WebSocket initialization failed"),{service:"websocket",operation:"initialize"},"high")}}async initializeSupabaseRealtime(){console.log("üîå Initializing Supabase Realtime..."),this.setupSupabaseRealtimeListeners()}async initializeSSE(){console.log("üîå Initializing SSE...");try{await y.connect(),this.setupSSEListeners()}catch(e){console.warn("‚ö†Ô∏è SSE initialization failed:",e)}}setupWebSocketListeners(){S.on("location-updates","bus:locationUpdate",e=>{this.handleEvent("bus-location-update","websocket",e,"high")}),S.on("general-updates","driver:connected",e=>{this.handleEvent("driver-connected","websocket",e,"medium")}),S.on("general-updates","driver:disconnected",e=>{this.handleEvent("driver-disconnected","websocket",e,"medium")}),S.on("general-updates","bus:arriving",e=>{this.handleEvent("bus-arriving","websocket",e,"high")})}setupSupabaseRealtimeListeners(){z.subscribeToBusLocations(e=>{this.handleEvent("bus-location-update","supabase",e,"high")}),z.subscribeToBusUpdates(e=>{this.handleEvent("bus-update","supabase",e,"medium")}),z.subscribeToRouteUpdates(e=>{this.handleEvent("route-update","supabase",e,"medium")}),z.subscribeToDriverAssignments(e=>{this.handleEvent("driver-assignment-update","supabase",e,"medium")})}setupSSEListeners(){y.subscribe("bus-location-update",e=>{this.handleEvent("bus-location-update","sse",e.data,"high")}),y.subscribe("bus-status-update",e=>{this.handleEvent("bus-status-update","sse",e.data,"medium")}),y.subscribe("route-update",e=>{this.handleEvent("route-update","sse",e.data,"medium")}),y.subscribe("system-notification",e=>{this.handleEvent("system-notification","sse",e.data,"low")})}handleEvent(e,t,n,s){const i={type:e,source:t,data:n,timestamp:Date.now(),priority:s};console.log(`üì° Realtime event: ${e} from ${t} (${s} priority)`,i);const o=this.eventListeners.get(e);o&&o.forEach(a=>{try{a(i)}catch(u){console.error(`‚ùå Error in realtime event listener for ${e}:`,u)}})}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const n=this.eventListeners.get(e);if(n){const s=n.indexOf(t);s>-1&&n.splice(s,1)}}emit(e,t,n="medium"){const s=n==="high"?"location-updates":"general-updates";S.emit(s,e,t)}getConnectionStatus(){return{websocket:S.getAllConnectionStatus(),supabase:z.getActiveSubscriptions(),sse:y.getConnectionStatus()}}async healthCheck(){const[e,t,n]=await Promise.all([this.checkWebSocketHealth(),z.healthCheck(),y.healthCheck()]),s=e.healthy||t.healthy||n.healthy;return{websocket:e,supabase:t,sse:n,overall:s}}async checkWebSocketHealth(){const e=S.getAllConnectionStatus();return{healthy:e.some(n=>n.isConnected),details:{connections:e,totalConnections:e.length,connectedConnections:e.filter(n=>n.isConnected).length}}}startHealthCheck(){this.healthCheckInterval=setInterval(async()=>{try{const e=await this.healthCheck();e.overall?console.log("‚úÖ Realtime health check passed"):(console.warn("‚ö†Ô∏è Realtime health check failed:",e),await this.handleHealthFailure())}catch(e){console.error("‚ùå Error during realtime health check:",e)}},3e4)}async handleHealthFailure(){if(console.log("üîÑ Attempting to recover from realtime health failure..."),this.config.enableWebSocket)try{await S.connect("location-updates"),await S.connect("general-updates")}catch(e){console.error("‚ùå Failed to reconnect WebSocket:",e)}if(this.config.enableSSE)try{await y.connect()}catch(e){console.error("‚ùå Failed to reconnect SSE:",e)}}configure(e){this.config={...this.config,...e},console.log("‚öôÔ∏è RealtimeManager configuration updated:",this.config)}getConfig(){return{...this.config}}destroy(){console.log("üßπ Destroying RealtimeManager..."),this.healthCheckInterval&&clearInterval(this.healthCheckInterval),S.destroy(),z.destroy(),y.destroy(),this.eventListeners.clear(),this.isInitialized=!1,console.log("‚úÖ RealtimeManager destroyed")}}const L=new Fe;class Ue{constructor(){p(this,"buses",{});p(this,"previousLocations",{})}calculateSpeed(e,t,n,s,i){const a=this.toRadians(n-e),u=this.toRadians(s-t),m=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this.toRadians(e))*Math.cos(this.toRadians(n))*Math.sin(u/2)*Math.sin(u/2),h=6371*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m))),C=i/(1e3*60*60),v=h/C;return Math.round(v*10)/10}toRadians(e){return e*(Math.PI/180)}updateBusLocation(e){var u,m;const{busId:t,latitude:n,longitude:s,timestamp:i}=e,o=this.previousLocations[t];let a;if(o){const g=new Date(i).getTime()-new Date(o.timestamp).getTime();g>0&&(a=this.calculateSpeed(o.latitude,o.longitude,n,s,g))}this.buses[t]?(this.buses[t].currentLocation={...e,speed:a||e.speed},this.buses[t].eta=(m=e.eta)==null?void 0:m.estimated_arrival_minutes):this.buses[t]={busId:t,busNumber:`Bus ${t}`,routeName:"Route TBD",driverName:"Driver TBD",currentLocation:{...e,speed:a||e.speed},eta:(u=e.eta)==null?void 0:u.estimated_arrival_minutes},this.previousLocations[t]={latitude:n,longitude:s,timestamp:i}}getBus(e){return this.buses[e]||null}getAllBuses(){return Object.values(this.buses)}getBusesByRoute(e){return Object.values(this.buses).filter(t=>t.routeName===e)}async syncBusFromAPI(e,t){try{if(!t){const n=await oe.getBusInfo(e);if(n.success&&n.data)t=n.data;else{console.error("‚ùå Failed to fetch bus data from API for bus:",e);return}}this.buses[e]?this.buses[e]={...this.buses[e],busNumber:t.number_plate||t.code||`Bus ${e}`,routeName:t.route_name||"Route TBD",driverName:t.driver_full_name||"Driver TBD"}:this.buses[e]={busId:e,busNumber:t.number_plate||t.code||`Bus ${e}`,routeName:t.route_name||"Route TBD",driverName:t.driver_full_name||"Driver TBD",currentLocation:{busId:e,driverId:t.assigned_driver_id||"",latitude:0,longitude:0,timestamp:new Date().toISOString()}}}catch(n){console.error("‚ùå Error syncing bus data from API:",n)}}async syncAllBusesFromAPI(){try{const e=await oe.getAllBuses();e.success&&e.data&&e.data.forEach(t=>{this.syncBusFromAPI(t.id,t)})}catch(e){console.error("‚ùå Error syncing all buses from API:",e)}}clearBuses(){this.buses={},this.previousLocations={}}getBusStats(){const e=Object.values(this.buses),t={};return e.forEach(n=>{const s=n.routeName;t[s]=(t[s]||0)+1}),{totalBuses:e.length,activeBuses:e.filter(n=>n.currentLocation).length,busesByRoute:t}}getActiveBuses(){const e=new Date(Date.now()-3e5);return Object.values(this.buses).filter(t=>new Date(t.currentLocation.timestamp)>e)}getBusLocationHistory(e){const t=this.buses[e];return t?[t.currentLocation]:[]}updateBusETA(e,t){this.buses[e]&&(this.buses[e].eta=t)}getBusesNearLocation(e,t,n=5){return Object.values(this.buses).filter(s=>{const i=s.currentLocation.latitude,o=s.currentLocation.longitude,a=6371,u=this.toRadians(i-e),m=this.toRadians(o-t),g=Math.sin(u/2)*Math.sin(u/2)+Math.cos(this.toRadians(e))*Math.cos(this.toRadians(i))*Math.sin(m/2)*Math.sin(m/2),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g));return a*h<=n})}}const F=new Ue;class We{constructor(){p(this,"worker",null);p(this,"callbacks",new Map);p(this,"isSupported");this.isSupported=typeof Worker<"u",this.isSupported&&this.initializeWorker()}initializeWorker(){try{this.worker=new Worker(new URL("/assets/calculations.worker-BkzK_Pkx.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const{type:t,data:n}=e.data,s=this.callbacks.get(t);s&&(s(n),this.callbacks.delete(t))},this.worker.onerror=e=>{console.error("‚ùå Worker error:",e)}}catch{console.warn("‚ö†Ô∏è Web Worker not supported, falling back to main thread"),this.isSupported=!1}}async calculateSpeed(e,t,n,s,i){return!this.isSupported||!this.worker?this.calculateSpeedFallback(e,t,n,s,i):new Promise(o=>{this.callbacks.set("SPEED_CALCULATED",o),this.worker.postMessage({type:"CALCULATE_SPEED",data:{lat1:e,lon1:t,lat2:n,lon2:s,timeDiffMs:i}})})}async calculateETA(e,t,n=30){return!this.isSupported||!this.worker?this.calculateETAFallback(e,t,n):new Promise(s=>{this.callbacks.set("ETA_CALCULATED",s),this.worker.postMessage({type:"CALCULATE_ETA",data:{currentLocation:e,destination:t,averageSpeed:n}})})}async calculateDistance(e,t){return!this.isSupported||!this.worker?this.calculateDistanceFallback(e,t):new Promise(n=>{this.callbacks.set("DISTANCE_CALCULATED",n),this.worker.postMessage({type:"CALCULATE_DISTANCE",data:{point1:e,point2:t}})})}calculateSpeedFallback(e,t,n,s,i){const o=this.calculateDistanceFallback({latitude:e,longitude:t},{latitude:n,longitude:s}),a=i/(1e3*60*60),u=o/a;return Math.round(u*10)/10}calculateETAFallback(e,t,n=30){const s=this.calculateDistanceFallback({latitude:e.latitude,longitude:e.longitude},t),i=s/n,o=Math.round(i*60),a=s<.5;return{estimated_arrival_minutes:o,distance_remaining:Math.round(s*10)/10,is_near_stop:a}}calculateDistanceFallback(e,t){const s=this.toRadians(t.latitude-e.latitude),i=this.toRadians(t.longitude-e.longitude),o=Math.sin(s/2)*Math.sin(s/2)+Math.cos(this.toRadians(e.latitude))*Math.cos(this.toRadians(t.latitude))*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}toRadians(e){return e*(Math.PI/180)}terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.callbacks.clear()}}const ie=new We,He=De()(we((l,e)=>({isConnected:!1,connectionError:null,connectionStatus:"disconnected",buses:[],routes:[],selectedRoute:"all",lastBusLocations:{},viewport:{bounds:[[72.5,22.8],[73.2,23.4]],zoom:12,center:[72.8777,23.0225]},busClusters:[],spatialIndex:new Map,visibleBuses:[],visibleRoutes:[],isLoading:!0,isNavbarCollapsed:!1,isRouteFilterOpen:!0,isActiveBusesOpen:!0,isClusteringEnabled:!0,isHeatmapEnabled:!1,setConnectionState:t=>l(n=>({...n,...t})),setBuses:t=>l(()=>{const n=new Map;return t.forEach(s=>{if(s.currentLocation){const i=`${Math.floor(s.currentLocation.longitude*100)},${Math.floor(s.currentLocation.latitude*100)}`;n.set(i,s)}}),{buses:t,spatialIndex:n}}),updateBusLocation:t=>l(n=>{const s=n.buses.map(u=>{var m;return u.busId===t.busId?{...u,currentLocation:t,eta:(m=t.eta)==null?void 0:m.estimated_arrival_minutes}:u}),i=new Map(n.spatialIndex),o=`${Math.floor(t.longitude*100)},${Math.floor(t.latitude*100)}`,a=s.find(u=>u.busId===t.busId);return a&&i.set(o,a),{lastBusLocations:{...n.lastBusLocations,[t.busId]:t},buses:s,spatialIndex:i}}),removeBus:t=>l(n=>{const s=n.buses.filter(a=>a.busId!==t),i=Object.fromEntries(Object.entries(n.lastBusLocations).filter(([a])=>a!==t)),o=new Map;return s.forEach(a=>{if(a.currentLocation){const u=`${Math.floor(a.currentLocation.longitude*100)},${Math.floor(a.currentLocation.latitude*100)}`;o.set(u,a)}}),{buses:s,lastBusLocations:i,spatialIndex:o}}),setRoutes:t=>l({routes:t}),setSelectedRoute:t=>l({selectedRoute:t}),setLoading:t=>l({isLoading:t}),setNavbarCollapsed:t=>l({isNavbarCollapsed:t}),setRouteFilterOpen:t=>l({isRouteFilterOpen:t}),setActiveBusesOpen:t=>l({isActiveBusesOpen:t}),setViewport:t=>l(n=>{const s={viewport:t},i=n.buses.filter(a=>{if(!a.currentLocation)return!1;const[u,m]=t.bounds[0],[g,h]=t.bounds[1];return a.currentLocation.longitude>=u&&a.currentLocation.longitude<=g&&a.currentLocation.latitude>=m&&a.currentLocation.latitude<=h}),o=n.routes.filter(a=>{if(!a.stops||!a.stops.coordinates)return!1;const u=a.stops.coordinates,[m,g]=t.bounds[0],[h,C]=t.bounds[1];return u.some(([v,N])=>v>=m&&v<=h&&N>=g&&N<=C)});return{...s,visibleBuses:i,visibleRoutes:o}}),updateSpatialIndex:()=>l(t=>{const n=new Map;return t.buses.forEach(s=>{if(s.currentLocation){const i=`${Math.floor(s.currentLocation.longitude*100)},${Math.floor(s.currentLocation.latitude*100)}`;n.set(i,s)}}),{spatialIndex:n}}),calculateClusters:()=>l(t=>{if(!t.isClusteringEnabled||t.visibleBuses.length===0)return{busClusters:[]};const n=[],s=Math.max(50,1e3/Math.pow(2,t.viewport.zoom-10)),i=new Set;return t.visibleBuses.forEach(o=>{if(i.has(o.busId)||!o.currentLocation)return;const a=[o];if(i.add(o.busId),t.visibleBuses.forEach(u=>{if(i.has(u.busId)||!u.currentLocation)return;Math.sqrt(Math.pow(o.currentLocation.longitude-u.currentLocation.longitude,2)+Math.pow(o.currentLocation.latitude-u.currentLocation.latitude,2))*111e3<=s&&(a.push(u),i.add(u.busId))}),a.length>1){const u=a.reduce((v,N)=>v+N.currentLocation.longitude,0)/a.length,m=a.reduce((v,N)=>v+N.currentLocation.latitude,0)/a.length,g=a.map(v=>v.currentLocation.longitude),h=a.map(v=>v.currentLocation.latitude),C=[[Math.min(...g),Math.min(...h)],[Math.max(...g),Math.max(...h)]];n.push({id:`cluster-${n.length}`,center:[u,m],buses:a,count:a.length,bounds:C})}else n.push({id:`cluster-${n.length}`,center:[o.currentLocation.longitude,o.currentLocation.latitude],buses:[o],count:1,bounds:[[o.currentLocation.longitude,o.currentLocation.latitude],[o.currentLocation.longitude,o.currentLocation.latitude]]})}),{busClusters:n}}),querySpatialData:t=>l(n=>{let s=n.buses;if(t.bounds){const[i,o]=t.bounds[0],[a,u]=t.bounds[1];s=s.filter(m=>m.currentLocation?m.currentLocation.longitude>=i&&m.currentLocation.longitude<=a&&m.currentLocation.latitude>=o&&m.currentLocation.latitude<=u:!1)}if(t.center&&t.radius){const[i,o]=t.center,a=t.radius/111e3;s=s.filter(u=>u.currentLocation?Math.sqrt(Math.pow(u.currentLocation.longitude-i,2)+Math.pow(u.currentLocation.latitude-o,2))<=a:!1)}return{visibleBuses:s}}),toggleClustering:()=>l(t=>({isClusteringEnabled:!t.isClusteringEnabled})),toggleHeatmap:()=>l(t=>({isHeatmapEnabled:!t.isHeatmapEnabled})),getActiveBuses:()=>{const t=e(),n=new Date(Date.now()-5*60*1e3);return t.buses.filter(s=>s.currentLocation?new Date(s.currentLocation.timestamp)>n:!1)},getBusesByRoute:t=>{const n=e();return t==="all"?n.buses:n.buses.filter(s=>s.routeName.includes(t))},getFilteredBuses:()=>{const t=e();return t.getBusesByRoute(t.selectedRoute)},getBusesInViewport:()=>e().visibleBuses,getRoutesInViewport:()=>e().visibleRoutes,getBusClusters:()=>e().busClusters}),{name:"map-store"})),qe=({buses:l,itemHeight:e=80,containerHeight:t=400,onBusSelect:n,selectedBusId:s})=>{const[i,o]=f.useState(0),a=f.useMemo(()=>{const h=Math.floor(i/e),C=Math.min(h+Math.ceil(t/e)+1,l.length);return l.slice(h,C).map((v,N)=>({bus:v,index:h+N}))},[l,i,e,t]),u=l.length*e,m=f.useCallback(h=>{o(h.currentTarget.scrollTop)},[]),g=f.useCallback(h=>{n==null||n(h)},[n]);return l.length===0?c.jsxDEV("div",{className:"flex items-center justify-center h-full",children:c.jsxDEV("p",{className:"text-white/60",children:"No buses available"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:53,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:52,columnNumber:7},void 0):c.jsxDEV("div",{className:"relative overflow-hidden",style:{height:t},children:[c.jsxDEV("div",{className:"overflow-auto",style:{height:t},onScroll:m,children:c.jsxDEV("div",{style:{height:u}},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:70,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:64,columnNumber:7},void 0),c.jsxDEV("div",{className:"absolute top-0 left-0 right-0",children:c.jsxDEV(U,{children:a.map(({bus:h,index:C})=>c.jsxDEV(W.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.2},style:{position:"absolute",top:C*e,left:0,right:0,height:e},children:c.jsxDEV(M,{className:`m-2 cursor-pointer transition-all duration-200 ${s===h.busId?"ring-2 ring-blue-400 bg-blue-500/20":"hover:bg-white/10"}`,onClick:()=>g(h),children:c.jsxDEV("div",{className:"flex items-center justify-between p-3",children:[c.jsxDEV("div",{className:"flex items-center space-x-3",children:[c.jsxDEV("div",{className:"w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center",children:c.jsxDEV("span",{className:"text-lg",children:"üöå"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:102,columnNumber:23},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:101,columnNumber:21},void 0),c.jsxDEV("div",{children:[c.jsxDEV("h3",{className:"text-white font-semibold",children:h.busNumber},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:105,columnNumber:23},void 0),c.jsxDEV("p",{className:"text-white/70 text-sm",children:h.routeName},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:108,columnNumber:23},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:104,columnNumber:21},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:100,columnNumber:19},void 0),c.jsxDEV("div",{className:"text-right",children:[c.jsxDEV("div",{className:"flex items-center space-x-2",children:[c.jsxDEV("div",{className:`w-2 h-2 rounded-full ${h.currentLocation?"bg-green-400 animate-pulse":"bg-red-400"}`},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:115,columnNumber:23},void 0),c.jsxDEV("span",{className:"text-white/60 text-xs",children:h.currentLocation?"Online":"Offline"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:122,columnNumber:23},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:114,columnNumber:21},void 0),h.currentLocation&&c.jsxDEV("p",{className:"text-white/60 text-xs mt-1",children:h.currentLocation.speed?`${h.currentLocation.speed} km/h`:"Speed N/A"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:127,columnNumber:23},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:113,columnNumber:19},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:99,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:91,columnNumber:15},void 0)},h.busId,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:77,columnNumber:13},void 0))},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:75,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:74,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/ui/VirtualBusList.tsx",lineNumber:59,columnNumber:5},void 0)},Je=ce.lazy(()=>ae(()=>import("./MapContainer-BeAxOB0k.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))),re=ce.lazy(()=>ae(()=>import("./BusMarker-CrDKL-TA.js"),__vite__mapDeps([10,2,7]))),st=({className:l=""})=>{const e=f.useRef(null),t=f.useRef(!1),n=f.useRef(new Set),[s,i]=f.useState(null),{isConnected:o,connectionError:a,connectionStatus:u,setConnectionState:m,lastBusLocations:g,setBuses:h,updateBusLocation:C,removeBus:v,setRoutes:N,viewport:j,busClusters:le,visibleBuses:ue,visibleRoutes:x,setViewport:q,calculateClusters:J,isClusteringEnabled:w,isHeatmapEnabled:T,toggleClustering:de,toggleHeatmap:me,isLoading:he,setLoading:P,getFilteredBuses:G}=He(),{data:k,isLoading:K}=ke(j.bounds,t.current),{data:R,isLoading:Z}=Re(j.bounds,t.current),{data:D}=ze(j.bounds,t.current),{data:I}=Me(j.bounds,j.zoom,w&&t.current),Q=f.useMemo(()=>G(),[G]),fe=f.useCallback(r=>{console.log("üó∫Ô∏è Map loaded successfully"),e.current&&e.current!==r&&(console.log("üó∫Ô∏è Map already assigned, cleaning up previous instance"),e.current.remove()),e.current=r,t.current=!0,P(!1)},[P]),pe=f.useCallback(r=>{console.error("‚ùå Map error:",r),m({connectionError:"Map loading failed"})},[m]),ge=f.useCallback(r=>{console.log("üó∫Ô∏è Viewport changed:",r),q(r),w&&setTimeout(()=>J(),100)},[q,w,J]);f.useEffect(()=>{k!=null&&k.success&&k.data&&(console.log("‚úÖ Routes loaded from viewport query:",k.data.length),N(k.data))},[k,N]),f.useEffect(()=>{R!=null&&R.success&&R.data&&(console.log("‚úÖ Buses loaded from viewport query:",R.data.length),h(R.data.map(r=>({busId:r.id,busNumber:r.number_plate||r.code,routeName:r.route_name||"Route TBD",driverName:r.driver_full_name||"Driver TBD",currentLocation:{busId:r.id,driverId:r.assigned_driver_id||"",latitude:0,longitude:0,timestamp:new Date().toISOString()}}))))},[R,h]),f.useEffect(()=>{D!=null&&D.success&&D.data&&D.data.forEach(async r=>{var b;const d={busId:r.busId,driverId:r.driverId||"",latitude:r.latitude,longitude:r.longitude,timestamp:r.timestamp,speed:r.speed,heading:r.heading,eta:r.eta};if(!r.speed&&F.getBus(r.busId)){const E=(b=F.getBus(r.busId))==null?void 0:b.currentLocation;if(E){const A=new Date(r.timestamp).getTime()-new Date(E.timestamp).getTime();if(A>0){const O=await ie.calculateSpeed(E.latitude,E.longitude,r.latitude,r.longitude,A);d.speed=O}}}C(d)})},[D,C]);const X=f.useCallback(()=>{e.current&&x.forEach(r=>{const d=`route-${r.id}`;try{e.current.getLayer(d)&&e.current.removeLayer(d),e.current.getSource(d)&&e.current.removeSource(d),n.current.delete(d)}catch(b){console.warn(`‚ö†Ô∏è Error removing route ${r.name}:`,b)}})},[x]),Y=f.useCallback(()=>{!e.current||x.length===0||(console.log("üó∫Ô∏è Adding routes to map:",x.length,"routes"),x.forEach((r,d)=>{const b=`route-${r.id}`;if(n.current.has(b)||e.current.getSource(b)){console.log(`üó∫Ô∏è Route ${b} already exists, skipping...`);return}try{e.current.addSource(b,{type:"geojson",data:{type:"Feature",properties:{name:r.name,description:r.description,distance:r.distance_km,duration:r.estimated_duration_minutes},geometry:r.stops}}),e.current.addLayer({id:b,type:"line",source:b,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":`hsl(${d*137.5%360}, 70%, 50%)`,"line-width":4,"line-opacity":.8}}),console.log(`üó∫Ô∏è Added route ${r.name} to map`),n.current.add(b)}catch(E){console.warn(`‚ö†Ô∏è Error adding route ${r.name}:`,E)}}))},[x]),be=f.useCallback(()=>{if(!e.current||Object.keys(g).length===0)return;const r=Object.values(g).map(d=>[d.longitude,d.latitude]);if(r.length===1)e.current.flyTo({center:r[0],zoom:16,duration:2e3});else if(r.length>1){const d=new window.maplibregl.LngLatBounds;r.forEach(b=>d.extend(b)),e.current.fitBounds(d,{padding:50,duration:2e3})}},[g]),_=f.useCallback(r=>{i(r.busId),e.current&&r.currentLocation&&e.current.flyTo({center:[r.currentLocation.longitude,r.currentLocation.latitude],zoom:16,duration:1e3})},[]),ve=f.useCallback(r=>{var E,A,O,ee,te,ne,se;console.log("üìç Real-time bus location update:",r);const d=r.data,b={busId:d.busId||((E=d.new)==null?void 0:E.bus_id),driverId:d.driverId||((A=d.new)==null?void 0:A.driver_id)||"",latitude:d.latitude||((O=d.new)==null?void 0:O.latitude),longitude:d.longitude||((ee=d.new)==null?void 0:ee.longitude),timestamp:d.timestamp||((te=d.new)==null?void 0:te.recorded_at),speed:d.speed||((ne=d.new)==null?void 0:ne.speed_kmh),heading:d.heading||((se=d.new)==null?void 0:se.heading_degrees),eta:d.eta};C(b)},[C]),Ce=f.useCallback(r=>{console.log("üöå Real-time driver connected:",r)},[]),Se=f.useCallback(r=>{console.log("üöå Real-time driver disconnected:",r);const d=r.data;v(d.busId)},[v]),Ne=f.useCallback(r=>{console.log("üöå Real-time bus arriving:",r)},[]),xe=f.useCallback(r=>{console.log("üöå Real-time bus update:",r);const d=r.data;d.new&&console.log("üîÑ Updating bus information:",d.new)},[]),Ee=f.useCallback(r=>{console.log("üõ£Ô∏è Real-time route update:",r);const d=r.data;d.new&&console.log("üîÑ Updating route information:",d.new)},[]);return f.useEffect(()=>((async()=>{try{m({connectionStatus:"connecting"}),console.log("üîå Initializing real-time services..."),await L.initialize(),L.on("bus-location-update",ve),L.on("driver-connected",Ce),L.on("driver-disconnected",Se),L.on("bus-arriving",Ne),L.on("bus-update",xe),L.on("route-update",Ee),m({isConnected:!0,connectionStatus:"connected",connectionError:null}),console.log("‚úÖ Real-time services initialized successfully")}catch(d){console.error("‚ùå Real-time initialization failed:",d),m({isConnected:!1,connectionStatus:"disconnected",connectionError:"Failed to initialize real-time services"})}})(),()=>{L.destroy()}),[m]),f.useEffect(()=>{t.current&&x.length>0&&(X(),Y())},[x,X,Y]),f.useEffect(()=>{P(K||Z)},[K,Z,P]),f.useEffect(()=>()=>{ie.terminate()},[]),c.jsxDEV("div",{className:`optimized-student-map-lazy ${l}`,children:[c.jsxDEV(f.Suspense,{fallback:c.jsxDEV("div",{className:"flex items-center justify-center h-screen",children:c.jsxDEV(M,{className:"p-8",children:[c.jsxDEV("div",{className:"loading-spinner mx-auto mb-4"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:458,columnNumber:13},void 0),c.jsxDEV("p",{className:"text-white text-center",children:"Loading map..."},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:459,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:457,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:456,columnNumber:9},void 0),children:c.jsxDEV(Je,{onMapLoad:fe,onMapError:pe,onViewportChange:ge,enableClustering:w,enableHeatmap:T},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:463,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:455,columnNumber:7},void 0),c.jsxDEV(f.Suspense,{fallback:null,children:w&&(I!=null&&I.success)?I.data.map(r=>c.jsxDEV(re,{map:e.current,location:{busId:r.id,driverId:"",latitude:r.center[1],longitude:r.center[0],timestamp:new Date().toISOString()},busInfo:{busNumber:`Cluster ${r.count}`,driverName:"",routeName:""},isConnected:o,onMarkerClick:_,isClustered:r.count>1,clusterCount:r.count},r.id,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:477,columnNumber:13},void 0)):Object.entries(g).map(([r,d])=>{const b=F.getBus(r);return!b||!e.current?null:c.jsxDEV(re,{map:e.current,location:d,busInfo:{busNumber:b.busNumber,driverName:b.driverName,routeName:b.routeName},isConnected:o,onMarkerClick:_},r,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:505,columnNumber:15},void 0)})},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:473,columnNumber:7},void 0),c.jsxDEV(U,{children:a&&c.jsxDEV(W.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:"absolute top-4 left-4 z-50",children:c.jsxDEV(M,{className:"p-4 bg-red-500/20 border-red-400/30",children:c.jsxDEV("p",{className:"text-red-200 text-sm",children:a},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:532,columnNumber:15},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:531,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:525,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:523,columnNumber:7},void 0),c.jsxDEV(U,{children:he&&c.jsxDEV(W.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-black/50 flex items-center justify-center z-40",children:c.jsxDEV(M,{className:"p-8",children:[c.jsxDEV("div",{className:"loading-spinner mx-auto mb-4"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:548,columnNumber:15},void 0),c.jsxDEV("p",{className:"text-white text-center",children:"Loading map..."},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:549,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:547,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:541,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:539,columnNumber:7},void 0),c.jsxDEV("div",{className:"absolute top-4 right-4 z-50",children:c.jsxDEV(M,{className:"p-4",children:c.jsxDEV("div",{className:"space-y-2",children:[c.jsxDEV("h4",{className:"text-white text-sm font-semibold",children:"Real-time Status"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:559,columnNumber:13},void 0),c.jsxDEV("div",{className:"space-y-1",children:[c.jsxDEV("div",{className:"flex items-center space-x-2",children:[c.jsxDEV("div",{className:`w-2 h-2 rounded-full ${o?"bg-green-400":"bg-red-400"}`},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:562,columnNumber:17},void 0),c.jsxDEV("span",{className:"text-white text-xs",children:[u==="connected"&&"WebSocket",u==="connecting"&&"Connecting...",u==="disconnected"&&"Disconnected",u==="reconnecting"&&"Reconnecting..."]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:567,columnNumber:17},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:561,columnNumber:15},void 0),c.jsxDEV("div",{className:"flex items-center space-x-2",children:[c.jsxDEV("div",{className:"w-2 h-2 rounded-full bg-blue-400"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:575,columnNumber:17},void 0),c.jsxDEV("span",{className:"text-white text-xs",children:"Supabase Realtime"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:576,columnNumber:17},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:574,columnNumber:15},void 0),c.jsxDEV("div",{className:"flex items-center space-x-2",children:[c.jsxDEV("div",{className:"w-2 h-2 rounded-full bg-purple-400"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:579,columnNumber:17},void 0),c.jsxDEV("span",{className:"text-white text-xs",children:"SSE"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:580,columnNumber:17},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:578,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:560,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:558,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:557,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:556,columnNumber:7},void 0),c.jsxDEV("div",{className:"absolute top-4 left-4 z-50 w-80",children:c.jsxDEV(M,{className:"p-4",children:[c.jsxDEV("h3",{className:"text-white font-semibold mb-3",children:"Spatial Controls"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:590,columnNumber:11},void 0),c.jsxDEV("div",{className:"space-y-2",children:[c.jsxDEV("button",{onClick:de,className:`w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors ${w?"bg-blue-600 text-white":"bg-gray-600 text-gray-300"}`,children:[w?"‚úÖ":"‚ùå"," Clustering"]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:592,columnNumber:13},void 0),c.jsxDEV("button",{onClick:me,className:`w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors ${T?"bg-green-600 text-white":"bg-gray-600 text-gray-300"}`,children:[T?"‚úÖ":"‚ùå"," Heatmap"]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:602,columnNumber:13},void 0),c.jsxDEV("div",{className:"text-xs text-white/70 mt-2",children:[c.jsxDEV("p",{children:["Viewport: ",ue.length," buses, ",x.length," routes"]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:613,columnNumber:15},void 0),c.jsxDEV("p",{children:["Clusters: ",le.length]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:614,columnNumber:15},void 0),c.jsxDEV("p",{children:["Zoom: ",j.zoom.toFixed(1)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:615,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:612,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:591,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:589,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:588,columnNumber:7},void 0),c.jsxDEV("div",{className:"absolute top-4 left-4 z-50 w-80",style:{top:"200px"},children:c.jsxDEV(M,{className:"p-4",children:[c.jsxDEV("h3",{className:"text-white font-semibold mb-3",children:["Active Buses (",Q.length,")"]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:624,columnNumber:11},void 0),c.jsxDEV(qe,{buses:Q,containerHeight:300,onBusSelect:_,selectedBusId:s||void 0},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:625,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:623,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:622,columnNumber:7},void 0),c.jsxDEV("button",{onClick:be,className:"absolute bottom-4 right-4 z-50 btn-primary",disabled:Object.keys(g).length===0,children:"Center Map"},void 0,!1,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:635,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/College Project/frontend/src/components/OptimizedStudentMapLazy.tsx",lineNumber:453,columnNumber:5},void 0)};export{st as default};
//# sourceMappingURL=OptimizedStudentMapLazy-BmbrWh2r.js.map
